<!DOCTYPE html>
<html>

    <head>
      <title>MovieGo Movies View</title>
      <meta charset="utf-8">

      <style>
            .tile {
                display: inline-block;
                border: 1px solid grey;
                background: silver;
                padding: 4px;
                text-align: center;
                font-size: 15px;
                width: 250px;
            }

      </style>

    </head>

    <%= render 'shared/header' %>
    <%= render 'shared/navigation' %>

    <body>
        <h1>Movies#list</h1>
        <p>Find me in app/views/movies/list.html.erb</p>

        <form>
        Zip Code: <input id="zip" type="text"> <br/>
        </form>

        <button onclick="httpGetAsync();">Find Movies</button>
        <br/>


        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
        <script>

            var thumbnails = new Object();
            thumbnails["Inferno"] = "assets/inferno.jpg";
            thumbnails["Keeping Up With the Joneses"] = "assets/kuwtj.jpg";
            thumbnails["Jack Reacher: Never Go Back"] = "assets/jackreacher.jpg"
            thumbnails["The Accountant"] = "assets/accountant.jpg"
            thumbnails["Doctor Strange 3D"] = "assets/drstrange.jpg"
            thumbnails["Doctor Strange"] = "assets/drstrange.jpg"
            thumbnails["Trolls"] = "assets/smallberg.jpg"
            thumbnails["Hacksaw Ridge"] = "assets/hacksawridge.jpg"

            var RESPONSE_INFO = "";

            function makePostRequest(payload) {
                console.log("Payload: " + payload);
                $.ajax({
                    url: 'map',
                    type: 'POST',
                    data: JSON.stringify(payload),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    async: true,
                    success: function(msg) {
                        alert(msg);
                    }
                });
            }

            function getMovieInfo(movie_index) {
                console.log("Movie Index: " + movie_index);
                var result = JSON.parse(RESPONSE_INFO);
                var movieInfo = result[movie_index];

                console.log("Movie Title: " + result[movie_index].title);

                makePostRequest(JSON.stringify(movieInfo));
            }


            function get_GET_REQUEST_URL() {
                var API_KEY = "ghbb64hj9th6yfu9dp8e6k4w";
                var BASE_URL = "http://data.tmsapi.com/v1.1/movies/showings?startDate=";

                // get the current date
                var today = new Date();
                var days = today.getDate();
                var months = today.getMonth() + 1;
                var years = today.getFullYear();

                if (days < 10)
                    days = "0" + days;
                if (months < 10)
                    months = "0" + months;

                // format the date string as 2016-11-03
                today = years + "-" + months + "-" + days; 

                //var ZIPCODE = 90024;
                var ZIPCODE = document.getElementById("zip").value;
                console.log("Zip code from user: " + ZIPCODE);

                // todo: need to validate zip code
                if (ZIPCODE < 0 || ZIPCODE > 99999) {
                    alert("Bad zip code!!");
                    ZIPCODE = 90024;
                }

                var FULL_URL = BASE_URL + today + "&zip=" + ZIPCODE + "&api_key=" + API_KEY;
                return FULL_URL;
            }


            function displayMovieShowtimes(showtimes) {
                console.log("hello!");
                //document.body.innerHtml += "<p>" + showtimes + "</p>";

                var result = JSON.parse(showtimes);
                
                // assign response to global variable, so we can access movie information
                // after a button click
                RESPONSE_INFO = showtimes;

                $(document.body).append("<pFound " + result.length + " movies showing!</p>");

                var movies = result.hits;

                var count = 0;

                $.each(result, function(index, movie) {
                    var movieData = "";
                    var imgsrc = thumbnails[movie.title];
              
                    if (imgsrc == undefined)
                        imgsrc = "assets/smallberg.jpg"

                    movieData += '<button onclick="getMovieInfo(' + index + ')">'

                    movieData += '<div class="tile"><img style="height: 100%; width: 100%; object-fit: contain" src="' + imgsrc + '"><br/>';

                    movieData += movie.title;
                    movieData += "</div>";
                    movieData += "</button>"
                    $(document.body).append(movieData);
                    count++;
                });

                console.log(showtimes);
            }

            function httpGetAsync() {
                console.log("hi!");
                var url = get_GET_REQUEST_URL();
                var callback = displayMovieShowtimes;
                var xmlHttp = new XMLHttpRequest();

                xmlHttp.onreadystatechange = function() {
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                        callback(xmlHttp.responseText);
                    }
                }
                xmlHttp.open("GET", url, true);
                xmlHttp.send(null);
            }
        </script>

    </body>

</html>
