<!DOCTYPE html>
<html>

    <head>
      <title>MovieGo Movies View</title>
      <meta charset="utf-8">

      <style>
      .tile {
        display: inline-block;
        border: 1px solid grey;
        background: silver;
        padding: 4px;
        text-align: center;
        font-size: 15px;
        width: 250px;
      }
      </style>

    </head>

    <%= render 'shared/header' %>
    <%= render 'shared/navigation' %>

    <body>
        <h1>Movies#list</h1>
        <p>Find me in app/views/movies/list.html.erb</p>

        <form>
        Zip Code: <input id="zip" type="text"> <br/>
        </form>

        <button onclick="httpGetAsync();">Find Movies</button>
        <br/>


        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
        <script>
            function get_GET_REQUEST_URL() {
                var API_KEY = "ghbb64hj9th6yfu9dp8e6k4w";
                var BASE_URL = "http://data.tmsapi.com/v1.1/movies/showings?startDate=";

                // get the current date
                var today = new Date();
                var days = today.getDate();
                var months = today.getMonth() + 1;
                var years = today.getFullYear();

                if (days < 10)
                    days = "0" + days;
                if (months < 10)
                    months = "0" + months;

                // format the date string as 2016-11-03
                today = years + "-" + months + "-" + days; 

                //var ZIPCODE = 90024;
                var ZIPCODE = document.getElementById("zip").value;
                console.log("Zip code from user: " + ZIPCODE);

                // todo: need to validate zip code
                if (ZIPCODE < 0 || ZIPCODE > 99999) {
                    alert("Bad zip code!!");
                    ZIPCODE = 90024;
                }

                var FULL_URL = BASE_URL + today + "&zip=" + ZIPCODE + "&api_key=" + API_KEY;
                return FULL_URL;
            }


            function displayMovieShowtimes(showtimes) {
                console.log("hello!");
                //document.body.innerHtml += "<p>" + showtimes + "</p>";

                var result = JSON.parse(showtimes);
                $(document.body).append("<pFound " + result.length + " movies showing!</p>");

                var movies = result.hits;

                var count = 0;

                $.each(result, function(index, movie) {
                    var movieData = "";
                    if (count % 2 == 0)
                        movieData +='<div class="tile"><img src="assets/smallberg.jpg"><br/>';
                    else
                        movieData +='<div class="tile"><img src="assets/smallberg2.jpg"><br/>';
                    movieData += movie.title;
                    movieData += "</div>";
                    $(document.body).append(movieData);
                    count++;
                });

                console.log(showtimes);
            }

            function httpGetAsync() {
                console.log("hi!");
                var url = get_GET_REQUEST_URL();
                var callback = displayMovieShowtimes;
                var xmlHttp = new XMLHttpRequest();

                xmlHttp.onreadystatechange = function() {
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                        callback(xmlHttp.responseText);
                    }
                }
                xmlHttp.open("GET", url, true);
                xmlHttp.send(null);
            }
        </script>

    </body>

</html>
